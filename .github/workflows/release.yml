name: Docker Build, Scan, and Push to AWS ECR

on:
  push:
    branches:
      - dev
      - prod
    paths:
      - "frontend/**"
      - "backend/**"
      - ".github/workflows/release.yml"
  pull_request:
    branches:
      - dev
      - prod
    paths:
      - "frontend/**"
      - "backend/**"
      - ".github/workflows/release.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment to build and push'
        required: true
        type: choice
        default: 'dev'
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ORGANIZATION: bluocean
  PROJECT_NAME: riskgps

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      run-tests: ${{ steps.set-env.outputs.run-tests }}
      is-push-event: ${{ steps.set-env.outputs.is-push-event }}
      should-build: ${{ steps.set-env.outputs.should-build }}
    steps:
      - name: Determine environment based on branch and event
        id: set-env
        run: |
          BRANCH="${{ github.ref_name }}"
          EVENT_NAME="${{ github.event_name }}"
          
          # Determine if this is a push event (not a PR)
          if [[ "$EVENT_NAME" == "push" ]]; then
            IS_PUSH="true"
          else
            IS_PUSH="false"
          fi
          
          # Determine environment and whether to run tests
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            RUN_TESTS="true"
            SHOULD_BUILD="true"
          elif [[ "$BRANCH" == "dev" ]]; then
            ENVIRONMENT="dev"
            RUN_TESTS="true"
            SHOULD_BUILD="true"
          elif [[ "$BRANCH" == "prod" ]]; then
            ENVIRONMENT="prod"
            RUN_TESTS="false"
            SHOULD_BUILD="true"
          else
            echo "âŒ Error: Branch '$BRANCH' is not supported. Only 'dev' and 'prod' branches are allowed."
            exit 1
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "run-tests=$RUN_TESTS" >> $GITHUB_OUTPUT
          echo "is-push-event=$IS_PUSH" >> $GITHUB_OUTPUT
          echo "should-build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          
          echo "âœ… Environment: $ENVIRONMENT"
          echo "âœ… Event: $EVENT_NAME"
          echo "âœ… Branch: $BRANCH"
          echo "âœ… Run Tests: $RUN_TESTS"
          echo "âœ… Push Event: $IS_PUSH"

  get-services:
    name: Get Services from SSM
    runs-on: ubuntu-latest
    needs: determine-environment
    outputs:
      services: ${{ steps.set-services.outputs.services }}
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::739962689681:role/GithubActionRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR Repository URLs from SSM
        id: set-services
        run: |
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          SSM_EC2_CREDENTIALS="/${{ env.ORGANIZATION }}/${{ env.PROJECT_NAME }}/${ENVIRONMENT}/ec2/credentials"
          
          echo "ðŸ“‹ Fetching credentials from SSM parameter: $SSM_EC2_CREDENTIALS"
          
          # Fetch SSM parameter with error handling
          CREDENTIALS=$(aws ssm get-parameter \
            --name "$SSM_EC2_CREDENTIALS" \
            --region ${{ env.AWS_REGION }} \
            --with-decryption \
            --query Parameter.Value \
            --output text 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "âŒ Error: Failed to retrieve SSM parameter: $SSM_EC2_CREDENTIALS"
            echo "Return value: $CREDENTIALS"
            exit 1
          fi
          
          # Parse repository URLs and extract service names from object keys
          # ecr_registry_repository_urls structure: {"backend": "...", "frontend": "..."}
          SERVICES=$(echo "$CREDENTIALS" | jq -r '.ecr_registry_repository_urls | keys | @json' 2>&1)
          
          if [ $? -ne 0 ] || [ -z "$SERVICES" ] || [ "$SERVICES" = "[]" ]; then
            echo "âŒ Error: No services found or failed to parse ecr_registry_repository_urls"
            echo "Services output: $SERVICES"
            exit 1
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "âœ… Services detected: $SERVICES"

  run-tests:
    name: Run Tests (${{ needs.determine-environment.outputs.environment }} Environment)
    runs-on: ubuntu-latest
    needs: [get-services, determine-environment]
    if: needs.determine-environment.outputs.run-tests == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.get-services.outputs.services) }}
    defaults:
      run:
        working-directory: ./${{ matrix.service }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.service }}/package-lock.json

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for ${{ matrix.service }}"
          npm ci || { echo "âŒ Failed to install dependencies"; exit 1; }

      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running tests for ${{ matrix.service }}"
          npm test -- --passWithNoTests || { echo "âŒ Tests failed"; exit 1; }
          echo "âœ… Tests passed for ${{ matrix.service }}"

  scan-files:
    name: Scan Source Files with Trivy (${{ needs.determine-environment.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [get-services, determine-environment]
    strategy:
      matrix:
        service: ${{ fromJson(needs.get-services.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for ${{ matrix.service }}"
          cd ${{ matrix.service }}
          npm ci || { echo "âŒ Failed to install dependencies"; exit 1; }

      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

  build-scan-push:
    name: Build, Scan, and Push to ECR
    runs-on: ubuntu-latest
    needs: [scan-files, get-services, determine-environment, run-tests]
    if: |
      always() &&
      needs.determine-environment.outputs.should-build == 'true' &&
      (needs.scan-files.result == 'success' || needs.scan-files.result == 'skipped') &&
      (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped')
    strategy:
      matrix:
        service: ${{ fromJson(needs.get-services.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::739962689681:role/GithubActionRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR Repository URLs and Versioning from SSM
        run: |
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          SSM_EC2_CREDENTIALS="/${{ env.ORGANIZATION }}/${{ env.PROJECT_NAME }}/${ENVIRONMENT}/ec2/credentials"
          SSM_CREDS="/${{ env.ORGANIZATION }}/creds/${ENVIRONMENT}"
          
          echo "ðŸ“‹ Fetching EC2 credentials from: $SSM_EC2_CREDENTIALS"
          
          # Fetch EC2 credentials
          CREDENTIALS=$(aws ssm get-parameter \
            --name "$SSM_EC2_CREDENTIALS" \
            --region ${{ env.AWS_REGION }} \
            --with-decryption \
            --query Parameter.Value \
            --output text 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "âŒ Error: Failed to fetch EC2 credentials from $SSM_EC2_CREDENTIALS"
            exit 1
          fi
          
          # Extract ECR registry from the service-specific URL
          ECR_REGISTRY=$(echo "$CREDENTIALS" | jq -r '.ecr_registry_repository_urls["${{ matrix.service }}"]' 2>&1 | cut -d '/' -f 1)
          
          if [ $? -ne 0 ] || [ -z "$ECR_REGISTRY" ]; then
            echo "âŒ Error: Failed to extract ECR registry for service ${{ matrix.service }}"
            exit 1
          fi
          
          # Get the full ECR image URL for the service
          ECR_IMAGE=$(echo "$CREDENTIALS" | jq -r '.ecr_registry_repository_urls["${{ matrix.service }}"]' 2>&1)
          
          if [ $? -ne 0 ] || [ -z "$ECR_IMAGE" ]; then
            echo "âŒ Error: Failed to find ECR repository URL for ${{ matrix.service }}"
            exit 1
          fi
          
          # Fetch versioning from SSM credentials parameter
          echo "ðŸ“‹ Fetching version info from: $SSM_CREDS"
          
          CREDS=$(aws ssm get-parameter \
            --name "$SSM_CREDS" \
            --region ${{ env.AWS_REGION }} \
            --with-decryption \
            --query Parameter.Value \
            --output text 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "âš ï¸  Warning: Could not fetch version info from $SSM_CREDS, using defaults"
            MAJOR_VERSION="1"
            MINOR_VERSION="0"
          else
            MAJOR_VERSION=$(echo "$CREDS" | grep '^MAJOR_VERSION=' | cut -d '=' -f 2)
            MINOR_VERSION=$(echo "$CREDS" | grep '^MINOR_VERSION=' | cut -d '=' -f 2)
            
            if [ -z "$MAJOR_VERSION" ] || [ -z "$MINOR_VERSION" ]; then
              echo "âš ï¸  Warning: MAJOR_VERSION or MINOR_VERSION not found, using defaults"
              MAJOR_VERSION="1"
              MINOR_VERSION="0"
            fi
          fi
          
          TAG="v${MAJOR_VERSION}.${MINOR_VERSION}.${{ github.run_number }}"
          IMAGE_NAME="${{ matrix.service }}:${TAG}"
          
          echo "âœ… ECR Registry: $ECR_REGISTRY"
          echo "âœ… Service: ${{ matrix.service }}"
          echo "âœ… Tag: $TAG"
          echo "âœ… Environment: $ENVIRONMENT"
          
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
          echo "MAJOR_VERSION=$MAJOR_VERSION" >> $GITHUB_ENV
          echo "MINOR_VERSION=$MINOR_VERSION" >> $GITHUB_ENV
          echo "ECR_REGISTRY=$ECR_REGISTRY" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "ECR_IMAGE=$ECR_IMAGE:${TAG}" >> $GITHUB_ENV

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "ðŸ”¨ Building Docker image: ${{ env.IMAGE_NAME }}"
          cd ${{ matrix.service }}
          docker build -t ${{ env.IMAGE_NAME }} -f Dockerfile . || { echo "âŒ Docker build failed"; exit 1; }
          echo "âœ… Docker image built successfully"

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_NAME }}
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      - name: Tag Docker image
        run: |
          echo "ðŸ·ï¸  Tagging image as: ${{ env.ECR_IMAGE }}"
          docker tag ${{ env.IMAGE_NAME }} ${{ env.ECR_IMAGE }} || { echo "âŒ Failed to tag image"; exit 1; }
          echo "âœ… Image tagged successfully"

      - name: Push Docker image to ECR
        run: |
          echo "ðŸ“¤ Pushing image to ECR: ${{ env.ECR_IMAGE }}"
          docker push ${{ env.ECR_IMAGE }} || { echo "âŒ Failed to push image to ECR"; exit 1; }
          echo "âœ… Image pushed to ECR successfully"

      - name: Image Summary
        run: |
          echo "ðŸ“Š Build Summary"
          echo "  Environment: ${{ env.ENVIRONMENT }}"
          echo "  Service: ${{ matrix.service }}"
          echo "  Image: ${{ env.ECR_IMAGE }}"
          echo "  Tag: ${{ env.TAG }}"

  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [build-scan-push, determine-environment]
    if: always()
    steps:
      - name: Check Job Status
        run: |
          if [[ "${{ needs.build-scan-push.result }}" == "failure" ]]; then
            echo "âŒ Workflow failed: Build, Scan, or Push step failed"
            exit 1
          fi

      - name: Generate Success Summary
        if: needs.build-scan-push.result == 'success'
        run: |
          ENV_UPPER=$(echo "${{ needs.determine-environment.outputs.environment }}" | tr '[:lower:]' '[:upper:]')
          echo "## ðŸŽ‰ Docker Build and Push Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | $ENV_UPPER |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tests Run** | ${{ needs.determine-environment.outputs.run-tests }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âœ… SUCCESS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run Number** | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Workflow Details:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.determine-environment.outputs.environment }}" == "dev" ]]; then
            echo "âœ… **Dev Environment**: Ran tests, built, scanned, and pushed to DEV ECR repository" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Prod Environment**: Built, scanned, and pushed to PROD ECR repository (tests skipped)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor the deployment pipeline" >> $GITHUB_STEP_SUMMARY
          echo "- Check ECR for the newly pushed images" >> $GITHUB_STEP_SUMMARY
          echo "- Verify image tags: v*.*.* format" >> $GITHUB_STEP_SUMMARY

      - name: Generate Failure Summary
        if: needs.build-scan-push.result != 'success'
        run: |
          ENV_UPPER=$(echo "${{ needs.determine-environment.outputs.environment }}" | tr '[:lower:]' '[:upper:]')
          echo "## âŒ Workflow Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | $ENV_UPPER |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âŒ FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| **Reason** | Build, Scan, or Push stage failed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Troubleshooting:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the logs for specific error messages" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify SSM parameters exist and are accessible" >> $GITHUB_STEP_SUMMARY
          echo "3. Check AWS credentials and IAM permissions" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify Docker image builds without errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          exit 1
